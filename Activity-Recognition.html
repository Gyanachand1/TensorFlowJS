
<html>

	<head>
		<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
		<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
		<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier"></script>

		<script>

			const knn = knnClassifier.create();

			// saves number of training examples per class
			var training_set = {"swimming": 0, "cycling": 0, "boxing": 0, "surfing": 0, "horse-riding": 0, "figure-skating": 0};

			// fill canvas with the screenshot captured from video stream
			function take_screenshot()
			{
				const stream = document.getElementById("movie");
				stream.pause();
				const canvas = document.getElementById("screenshot");
				const draw = canvas.getContext("2d");
				draw.drawImage(stream, 0, 0, width=640, height=480);
			}

			// add examples to training model
			async function add_example(label)
			{
				const canvas = document.getElementById("screenshot");
				const model = await mobilenet.load();
				const features = model.infer(canvas, 'conv_preds');

				var class_id = 0;
				switch (label)
				{
					case "swimming" : class_id = 1; break;
					case "cycling" : class_id = 2; break;
					case "boxing" : class_id = 3; break;
					case "surfing" : class_id = 4; break;
					case "horse-riding" : class_id = 5; break;
					case "figure-skating" : class_id = 6; break;
					// add more classes here as necessary, e.g. cooking, reading, painting etc..
				}
				const draw = canvas.getContext("2d");
				draw.fillStyle = "yellow";
				draw.font = "20px Arial";
				draw.fillText(label, 50, 100);
				knn.addExample(features, class_id);
				training_set[label]++;

				// prints the number of labeled examples per class
				for (activity in training_set)
				{
					console.log(activity, training_set[activity]);
				}

				// resume video playback
				const stream = document.getElementById("movie");
				stream.play();
			}

			// predicts sports activity from the screenshot captured in canvas
			async function predict_class()
			{
				const canvas = document.getElementById("screenshot");
				const model = await mobilenet.load();
				const features = model.infer(canvas, 'conv_preds');
				const result = await knn.predictClass(features);

				// prints predicted class-label in canvas
				const draw = canvas.getContext("2d");
				draw.fillStyle = "yellow";
				draw.font = "20px Arial";

				const activities = ['None', 'Swimming', 'Cycling', 'Boxing', 'Surfing', 'Horse Riding', 'Figure Skating'];
				draw.fillText(activities[result.label], 50, 100);

				// resume video playback
				const stream = document.getElementById("movie");
				stream.play();
			}

		</script>
	</head>

	<body>

		<video width="640" height="480" id="movie" controls autoplay muted playsinline>
			<source src="sports-activities.mp4" type="video/mp4"> </source>
		</video>

		<canvas width="640" height="480" id="screenshot"> </canvas>

		<br> <br>
		1. <button id="capture" style="background-color:#4682B4;color:white;width:100px;height:50px;font-size:16px">Capture</button>

		<br> <br>
		2. <button id="swimming" style="background-color:#708090;color:white;width:100px;height:50px;font-size:16px">Swimming</button>

		<button id="cycling" style="background-color:#708090;color:white;width:100px;height:50px;font-size:16px">Cycling</button>

		<button id="boxing" style="background-color:#708090;color:white;width:100px;height:50px;font-size:16px">Boxing</button>

		<button id="surfing" style="background-color:#708090;color:white;width:100px;height:50px;font-size:16px">Surfing</button>

		<button id="horse-riding" style="background-color:#708090;color:white;width:130px;height:50px;font-size:16px">Horse Riding</button>

		<button id="figure-skating" style="background-color:#708090;color:white;width:130px;height:50px;font-size:16px">Figure Skating</button>

		<br> <br>

		3. <button id="predict" style="background-color:#4682B4;color:white;width:100px;height:50px;font-size:16px">Predict</button>

		<script>

			document.getElementById("capture").addEventListener('click', () => take_screenshot());

			document.getElementById("swimming").addEventListener('click', () => add_example("swimming"));
			document.getElementById("cycling").addEventListener('click', () => add_example("cycling"));
			document.getElementById("boxing").addEventListener('click', () => add_example("boxing"));
			document.getElementById("surfing").addEventListener('click', () => add_example("surfing"));
			document.getElementById("figure-skating").addEventListener('click', () => add_example("figure-skating"));
			document.getElementById("horse-riding").addEventListener('click', () => add_example("horse-riding"));

			document.getElementById("predict").addEventListener('click', () => predict_class());

		</script>
	</body>
</html>
